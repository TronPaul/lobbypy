<html metal:use-macro="master.macros['base']">
   <tal:block metal:fill-slot="content">
      <div id="players">
         <script type="text/javascript">
            /*
             * Map of player ids to team/class
             */
            var players = {};
            var my_id = '${request.player.id}';
            setInterval(function() {
               jQuery.post('_get_players_delta', JSON.stringify(players), updatePlayers)
            }, 1000)
            

            function setTeam(i) {
               jQuery.post('_set_team', { 'team':i }, updatePlayers);
            }

            function setClass(i) {
               jQuery.post('_set_class', { 'class':i }, updatePlayers);
            }
            
            function updatePlayers(delta) {
               // TODO: check response
               players = jQuery.extend(true, {}, players, delta['modified']);
               for (var i = 0; i < delta['removed'].length; i++) {
                  delete players[delta['removed'][i]];
               }
               updatePlayersUI(delta);
            }

            /*
             * Update the UI with the provided delta
             * ie change in information
             */
            function updatePlayersUI(delta) {
               // add new players or make modifications from modified
               jQuery.each(delta['modified'], function(key, value) {
                  elems = $('#' + key);
                  if (elems.length > 0) { //Modify
                     if (value['team'] !== undefined) {
                        elems.detach().appendTo("#team-" + value['team']);
                     }
                     elems.children('#' + key + '-class').text(value['class']);
                  } else { //New
                     $('#team-' + value['team']).after('<li id="' + key +'">'+
                     '<span>' + 'Player Name' + '</span>' +
                     '<span>' + 'Player Class' + '</span></li>');
                  }
               });
               // remove any known players if deleted
               jQuery.each(delta['removed'], function(index, value) {
                  $('#' + value).remove();
               });
            }
         </script>
         <div id="class-picker" tal:condition="hasattr(request, 'player')">
            <a href="#" onclick="setClass(0)">Random</a>
            <a href="#" onclick="setClass(1)">Scout</a>
            <a href="#" onclick="setClass(2)">Soldier</a>
            <a href="#" onclick="setClass(3)">Pyro</a>
            <a href="#" onclick="setClass(4)">Demoman</a>
            <a href="#" onclick="setClass(5)">Heavy</a>
            <a href="#" onclick="setClass(6)">Engineer</a>
            <a href="#" onclick="setClass(7)">Medic</a>
            <a href="#" onclick="setClass(8)">Sniper</a>
            <a href="#" onclick="setClass(9)">Spy</a>
         </div>
         <a tal:condition="hasattr(request, 'player')" href="#" onclick="setTeam(1)">Team 1</a>
         <a tal:condition="not hasattr(request, 'player')" href="#">Team 1</a>
         <ul id="team-1">
            <li tal:repeat="lp [p for p in lobby.players if p.team == 1]" tal:attributes="id lp.player.id">
               <span tal:attributes="id '%s-name' % lp.player.id" tal:content="lp.player.name">Player Name</span>
               <span tal:attributes="id '%s-class' % lp.player.id" tal:content="lp.pclass">Player Class</span>
            </li>
         </ul>
         <a tal:condition="hasattr(request, 'player')" href="#" onclick="setTeam(2)">Team 2</a>
         <a tal:condition="not hasattr(request, 'player')" href="#">Team 2</a>
         <ul id="team-2">
            <li tal:repeat="lp [p for p in lobby.players if p.team == 2]" tal:attributes="id lp.player.id">
               <span tal:attributes="id '%s-name' % lp.player.id" tal:content="lp.player.name">Player Name</span>
               <span tal:attributes="id '%s-class' % lp.player.id" tal:content="lp.pclass">Player Class</span>
            </li>
         </ul>
         <a tal:condition="hasattr(request, 'player')" href="#" onclick="setTeam(0)">Spectators</a>
         <a tal:condition="not hasattr(request, 'player')" href="#">Spectators</a>
         <ul id="team-0">
            <li tal:repeat="lp [p for p in lobby.players if p.team == 0]" tal:attributes="id lp.player.id">
               <span tal:attributes="id '%s-name' % lp.player.id" tal:content="lp.player.name">Player Name</span>
               <span tal:attributes="id '%s-class' % lp.player.id" tal:content="lp.pclass">Player Class</span>
            </li>
         </ul>
      </div>
      <div>
         <a href="${request.route_url('lobby_leave', lobby_id=lobby.id)}">Leave Lobby</a>
      </div>
   </tal:block>
</html>
