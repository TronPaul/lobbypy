<html metal:use-macro="master.macros['base']">
   <div metal:fill-slot="content">
      <div id="players">
         <script type="text/javascript">
            /*
             * Map of player ids to team/class
             */
            var players = {};
            var my_id = '${request.player.id}';

            jQuery.post('_get_players_delta', JSON.stringify(players), updatePlayers)

            function setTeam(i) {
               jQuery.post('_set_team', { 'team':i }, updatePlayers);
            }

            function setClass(i) {
               jQuery.post('_set_class', { 'class':i }, updatePlayers);
            }
            
            function updatePlayers(delta) {
               // TODO: check response
               players = jQuery.extend(true, {}, players, delta['modified']);
               for (var i = 0; i < delta['removed'].length; i++) {
                  delete players[delta['removed'][i]];
               }
               updatePlayersUI(delta);
            }

            /*
             * Update the UI with the provided delta
             * ie change in information
             */
            function updatePlayersUI(delta) {
               // add new players or make modifications from modified
               jQuery.each(delta['modified'], function(key, value) {
                  elems = $("#" + key).detach();
                  if (elems.length > 0) { //Modify
                     elems.appendTo("#team-" + value['team']);
                  } else { //New
                     $('#team-' + value['team']).after('<li id="' + key +'"><span>' + '</span></li>');
                  }
               });
               // remove any known players if deleted
               jQuery.each(delta['removed'], function(index, value) {
                  $('#' + value).remove();
               });
            }
         </script>
         <a href="#" onclick="setTeam(1)">Team 1</a>
         <ul id="team-1">
            <li tal:repeat="player [p.player for p in lobby.players if p.team == 1]" tal:attributes="id player.id">
               <span tal:content="player.name">Player Name</span>
            </li>
         </ul>
         <a href="#" onclick="setTeam(2)">Team 2</a>
         <ul id="team-2">
            <li tal:repeat="player [p.player for p in lobby.players if p.team == 2]" tal:attributes="id player.id">
               <span tal:content="player.name">Player Name</span>
            </li>
         </ul>
         <a href="#" onclick="setTeam(0)">Spectators</a>
         <ul id="team-0">
            <li tal:repeat="player [p.player for p in lobby.players if p.team == 0]" tal:attributes="id player.id">
               <span tal:content="player.name">Player Name</span>
            </li>
         </ul>
      </div>
   </div>
</html>
